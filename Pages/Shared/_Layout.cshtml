@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - Vehicle Tax System</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .navbar .nav-link {
            transition: all .2s ease-in-out;
        }

        .navbar .nav-link:hover {
            color: #ffc107 !important;
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
    <div class="container-fluid">

        <a class="navbar-brand d-flex align-items-center gap-2" asp-page="/Index">
            <img src="/images/Logo_of_Garowe_District.jpg" width="40" height="40" />
            <span class="fw-bold text-uppercase">
                Garowe Municipality Track Tax
            </span>
        </a>

        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">

            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    var isAdmin = User.IsInRole("Admin");

                    <li class="nav-item">
                        <a class="nav-link" asp-page="/Index">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>

                    @if (isAdmin || User.HasClaim("permission", "vehicle.view"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/Vehicles/Index">
                                <i class="bi bi-truck"></i> Vehicles
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "vehicle.view"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/CarTypes/Index">
                                <i class="bi bi-diagram-3"></i> Car Types
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "vehicle.view"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/Movements/Index">
                                <i class="bi bi-arrow-left-right"></i> Movements
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "vehicle.view"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/TaxAmounts/Index">
                                <i class="bi bi-currency-dollar"></i> Tax Amounts
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "payment.view"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/ReceiptReferences/Index">
                                <i class="bi bi-upload"></i> Manage Ref
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "payment.create"))
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-page="/Payments/Collect">
                                <i class="bi bi-cash-stack"></i> Collect Tax
                            </a>
                        </li>
                    }

                    @if (isAdmin || User.HasClaim("permission", "reports.view"))
                    {
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center gap-1"
                               href="#"
                               role="button"
                               data-bs-toggle="dropdown">
                                <i class="bi bi-bar-chart-line"></i> Reports
                            </a>

                            <ul class="dropdown-menu shadow border-0">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/Index">
                                        <i class="bi bi-graph-up-arrow"></i>
                                        Payment Report
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Transactions/Index">
                                        <i class="bi bi-journal-text"></i>
                                        Payment Logs
                                    </a>
                                </li>
                                 <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/vehicles">
                                        <i class="bi bi-journal-text"></i>
                                        Vehicle Report
                                    </a>
                                </li>
                                 <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/movements">
                                        <i class="bi bi-journal-text"></i>
                                        Movement List Report
                                    </a>
                                </li>
                                   <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/taxmovement">
                                        <i class="bi bi-journal-text"></i>
                                        Movement Overal Report
                                    </a>
                                </li>
                                  <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/taxmovementcartype">
                                        <i class="bi bi-journal-text"></i>
                                        Movement Tax Report
                                    </a>
                                </li>
                                   <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/usersreport">
                                        <i class="bi bi-journal-text"></i>
                                        Users Report
                                    </a>
                                </li>
                                  <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/TaxAmountReport">
                                        <i class="bi bi-journal-text"></i>
                                        Tax Amount Report
                                    </a>
                                </li>
                                  <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       asp-page="/Reports/ReceiptReferences">
                                        <i class="bi bi-journal-text"></i>
                                        ReceiptReferences Report
                                    </a>
                                </li>
                            </ul>
                        </li>
                    }

                    @if (isAdmin ||
                         User.HasClaim("permission", "user.view") ||
                         User.HasClaim("permission", "user.create"))
                    {
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center gap-1"
                               href="#"
                               role="button"
                               data-bs-toggle="dropdown">
                                <i class="bi bi-people"></i> Users
                            </a>

                            <ul class="dropdown-menu shadow border-0">
                                @if (isAdmin || User.HasClaim("permission", "user.view"))
                                {
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2"
                                           asp-page="/Account/Users">
                                            <i class="bi bi-list-ul"></i>
                                            Manage Users
                                        </a>
                                    </li>
                                }

                                @if (isAdmin || User.HasClaim("permission", "user.create"))
                                {
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2"
                                           asp-page="/Account/Register">
                                            <i class="bi bi-person-plus"></i>
                                            Create User
                                        </a>
                                    </li>
                                }

                                @if (isAdmin || User.HasClaim("permission", "user.view"))
                                {
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2"
                                           asp-page="/Account/UserSecurity">
                                            <i class="bi bi-shield-lock"></i>
                                            User Security
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>

            <ul class="navbar-nav ms-auto align-items-center">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2"
                           href="#"
                           role="button"
                           data-bs-toggle="dropdown">

                            <span class="rounded-circle bg-warning text-dark fw-bold d-flex justify-content-center align-items-center"
                                  style="width:32px;height:32px;">
                                @User.Identity!.Name!.Substring(0,1).ToUpper()
                            </span>

                            <span class="fw-semibold">@User.Identity.Name</span>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                            <li class="px-3 py-2">
                                <div class="fw-bold">@User.Identity.Name</div>
                                <small class="text-muted">
                                    @(User.IsInRole("Admin") ? "Administrator" : "User")
                                </small>
                            </li>

                            <li><hr class="dropdown-divider" /></li>

                            <!-- ðŸ” Change Password -->
                            <li>
                                <a class="dropdown-item d-flex align-items-center"
                                   asp-page="/Account/ChangePassword">
                                    <i class="bi bi-key me-2"></i>
                                    Change Password
                                </a>
                            </li>

                            <li><hr class="dropdown-divider" /></li>

                            <!-- ðŸšª Logout -->
                            <li>
                                <button type="button"
                                        class="dropdown-item text-danger d-flex align-items-center"
                                        onclick="logoutUser()">
                                    <i class="bi bi-box-arrow-right me-2"></i>
                                    Logout
                                </button>
                            </li>
                        </ul>
                    </li>
                }
                else
                {
                    <li class="nav-item">
                        <a class="btn btn-sm btn-outline-light" asp-page="/Account/Login">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </a>
                    </li>
                }
            </ul>

        </div>
    </div>
</nav>

<main class="container mt-4 flex-fill">
    @RenderBody()
</main>

<footer class="mt-5 py-3 border-top text-center text-muted small">
    Â© @DateTime.Now.Year Garowe Municipality â€“ Vehicle Tax System
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

@RenderSection("Scripts", required: false)

<script>
    function logoutUser() {
        fetch('/Account/Logout', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(() => {
            window.location.replace('/Account/Login');
        })
        .catch(() => {
            window.location.replace('/Account/Login');
        });
    }

    window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
            window.location.replace('/Account/Login');
        }
    });
</script>

</body>
</html>
