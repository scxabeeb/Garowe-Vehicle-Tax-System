@page
@model VehicleTax.Web.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-primary">Dashboard</h2>
        <p class="text-muted mb-0">Vehicle Tax Collection Overview</p>
    </div>
</div>

<!-- TOP CARDS -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-primary text-white">
            <div class="card-body">
                <h6>Total Vehicles</h6>
                <h2>@Model.TotalVehicles</h2>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-dark text-white">
            <div class="card-body">
                <h6>Total Payments</h6>
                <h2>@Model.TotalPayments</h2>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-success text-white">
            <div class="card-body">
                <h6>Todayâ€™s Collection</h6>
                <h2>$@Model.TodayTotal</h2>
            </div>
        </div>
    </div>
</div>

<!-- CHARTS -->
<div class="row g-4 mb-4">

    <!-- DAILY -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6>Daily Collection</h6>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- MOVEMENT -->
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6>Movement Types</h6>
                <canvas id="movementChart"></canvas>

                <table class="table table-sm table-bordered mt-3" id="movementTable">
                    <thead class="table-light">
                        <tr>
                            <th>Movement</th>
                            <th class="text-end">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in Model.MovementTable)
                        {
                            <tr>
                                <td>@m.Movement</td>
                                <td class="text-end fw-bold">@m.Count</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Movement Pagination -->
                <nav>
                    <ul class="pagination pagination-sm justify-content-center" id="movementPagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- COLLECTOR -->
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6>Collector Performance</h6>
                <canvas id="collectorChart"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- RECENT PAYMENTS -->
<div class="card shadow-sm">
    <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold mb-0">Recent Payments</h6>

            <!-- Search -->
            <input type="text"
                   id="paymentSearch"
                   class="form-control form-control-sm w-25"
                   placeholder="Search all fields..." />
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-sm align-middle" id="paymentsTable">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Plate</th>
                        <th>Mobile</th>
                        <th>Movement</th>
                        <th>Collector</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var p in Model.RecentPayments)
                {
                    <tr>
                        <td>@p.PaidAt.ToString("yyyy-MM-dd")</td>
                        <td>@p.Vehicle?.PlateNumber</td>
                        <td>@p.Vehicle?.Mobile</td>
                        <td>@p.MovementType</td>
                        <td>@(p.Collector?.Username ?? "N/A")</td>
                        <td class="text-end fw-bold">$@p.Amount</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        <!-- Payments Pagination -->
        <nav>
            <ul class="pagination pagination-sm justify-content-center" id="paymentsPagination"></ul>
        </nav>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* =========================
   CHARTS
========================= */
const dailyChart = new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
        labels: @Html.Raw(Model.DailyLabels),
        datasets: [{
            label: 'Daily Collection',
            data: @Html.Raw(Model.DailyAmounts),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13,110,253,.25)',
            fill: true
        }]
    }
});

const movementChart = new Chart(document.getElementById('movementChart'), {
    type: 'doughnut',
    data: {
        labels: @Html.Raw(Model.MovementLabels),
        datasets: [{
            data: @Html.Raw(Model.MovementCounts),
            backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6610f2','#20c997']
        }]
    }
});

const collectorChart = new Chart(document.getElementById('collectorChart'), {
    type: 'bar',
    data: {
        labels: @Html.Raw(Model.CollectorLabels),
        datasets: [{
            label: 'Collected Amount',
            data: @Html.Raw(Model.CollectorAmounts),
            backgroundColor: '#198754'
        }]
    },
    options: {
        indexAxis: 'y',
        scales: { x: { beginAtZero: true } }
    }
});

/* =========================
   RECENT PAYMENTS SEARCH
========================= */
document.getElementById("paymentSearch").addEventListener("keyup", function () {
    const value = this.value.toLowerCase();
    document.querySelectorAll("#paymentsTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });
});

/* =========================
   PAGINATION FUNCTION
========================= */
function setupPagination(tableId, paginationId, rowsPerPage) {
    const table = document.getElementById(tableId);
    const pagination = document.getElementById(paginationId);
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    let currentPage = 1;
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    function render() {
        rows.forEach((row, index) => {
            row.style.display =
                index >= (currentPage - 1) * rowsPerPage &&
                index < currentPage * rowsPerPage ? "" : "none";
        });

        pagination.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            const a = document.createElement("a");
            a.className = "page-link";
            a.href = "#";
            a.innerText = i;
            a.onclick = e => {
                e.preventDefault();
                currentPage = i;
                render();
            };
            li.appendChild(a);
            pagination.appendChild(li);
        }
    }

    render();
}

/* =========================
   INIT PAGINATION
========================= */
// Payments table -> 10 rows
setupPagination("paymentsTable", "paymentsPagination", 10);

// Movement table -> 4 rows
setupPagination("movementTable", "movementPagination", 4);
</script>
