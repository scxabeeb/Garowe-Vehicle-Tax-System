@page
@model VehicleTax.Web.Pages.Reports.IndexModel

<h3 class="mb-4 fw-bold">Reports</h3>

<form method="get" class="card p-3 mb-4 shadow-sm">
    <div class="row g-3">

        <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" asp-for="FromDate" class="form-control" />
        </div>

        <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" asp-for="ToDate" class="form-control" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Plate Number</label>
            <input asp-for="PlateNumber" class="form-control" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Car Type</label>
            <select asp-for="CarTypeId"
                    asp-items="Model.CarTypes"
                    class="form-select">
                <option value="">All</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Movement</label>
            <select asp-for="MovementId"
                    asp-items="Model.Movements"
                    class="form-select">
                <option value="">All</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Collector</label>
            <select asp-for="CollectorId"
                    asp-items="Model.Collectors"
                    class="form-select">
                <option value="">All</option>
            </select>
        </div>

        <div class="col-md-6 d-flex align-items-end gap-2">
            <button class="btn btn-primary w-100">Apply Filters</button>
            <a asp-page="./Index" class="btn btn-secondary w-100">Reset</a>
        </div>
    </div>
</form>

<!-- EXPORT -->
<div class="d-flex justify-content-end mb-2">
    <a class="btn btn-success"
       asp-page-handler="ExportExcel"
       asp-route-FromDate="@Model.FromDate"
       asp-route-ToDate="@Model.ToDate"
       asp-route-PlateNumber="@Model.PlateNumber"
       asp-route-CarTypeId="@Model.CarTypeId"
       asp-route-MovementId="@Model.MovementId"
       asp-route-CollectorId="@Model.CollectorId">
        Export to Excel
    </a>
</div>

<!-- SUMMARY -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-primary text-white text-center">
            <div class="card-body">
                <h6>Total Vehicles</h6>
                <h3>@Model.TotalVehicles</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-warning text-dark text-center">
            <div class="card-body">
                <h6>Total Payments</h6>
                <h3>@Model.TotalPayments</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-success text-white text-center">
            <div class="card-body">
                <h6>Total Collected</h6>
                <h3>@Model.TotalAmount</h3>
            </div>
        </div>
    </div>
</div>

<!-- PAGE SIZE (EXTEND ONLY) -->
<form method="get" class="d-flex justify-content-between align-items-center mb-2">

    <input type="hidden" name="FromDate" value="@Model.FromDate" />
    <input type="hidden" name="ToDate" value="@Model.ToDate" />
    <input type="hidden" name="PlateNumber" value="@Model.PlateNumber" />
    <input type="hidden" name="CarTypeId" value="@Model.CarTypeId" />
    <input type="hidden" name="MovementId" value="@Model.MovementId" />
    <input type="hidden" name="CollectorId" value="@Model.CollectorId" />

    <div class="d-flex align-items-center gap-2">
        <label class="fw-bold">Show</label>

        <select name="PageSize"
                class="form-select form-select-sm w-auto"
                onchange="this.form.submit()">

            @if (Model.PageSize == 10)
            { <option value="10" selected>10</option> }
            else
            { <option value="10">10</option> }

            @if (Model.PageSize == 20)
            { <option value="20" selected>20</option> }
            else
            { <option value="20">20</option> }

            @if (Model.PageSize == 50)
            { <option value="50" selected>50</option> }
            else
            { <option value="50">50</option> }

            @if (Model.PageSize == 100)
            { <option value="100" selected>100</option> }
            else
            { <option value="100">100</option> }

            @if (Model.PageSize == 200)
            { <option value="200" selected>200</option> }
            else
            { <option value="200">200</option> }

            @if (Model.PageSize == -1)
            { <option value="-1" selected>All</option> }
            else
            { <option value="-1">All</option> }

        </select>
    </div>
</form>

<!-- PAYMENTS TABLE (UNCHANGED) -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-bordered table-striped table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Plate</th>
                    <th>Owner</th>
                    <th>Mobile</th>
                    <th>Car Type</th>
                    <th>Movement</th>
                    <th>Collector</th>
                    <th>Receipt Ref</th>
                    <th class="text-end">Amount</th>
                </tr>
            </thead>
            <tbody>
            @if (Model.Payments.Any())
            {
                foreach (var p in Model.Payments)
                {
                    <tr>
                        <td>@p.PaidAt.ToString("yyyy-MM-dd")</td>
                        <td>@p.Vehicle?.PlateNumber</td>
                        <td>@p.Vehicle?.OwnerName</td>
                        <td>@p.Vehicle?.Mobile</td>
                        <td>@p.Vehicle?.CarType?.Name</td>
                        <td>@(p.Movement?.Name ?? p.MovementType)</td>
                        <td>@(p.Collector?.Username ?? "System")</td>
                        <td>@(p.ReceiptReference?.ReferenceNumber ?? "-")</td>
                        <td class="text-end">@p.Amount</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center text-muted">No payments found</td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<!-- PAGINATION (ADDED ONLY) -->
@if (Model.TotalPages > 1 && Model.PageSize != -1)
{
    <nav class="mt-3">
        <ul class="pagination justify-content-center">

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link"
                       asp-page="./Index"
                       asp-route-CurrentPage="@i"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-FromDate="@Model.FromDate"
                       asp-route-ToDate="@Model.ToDate"
                       asp-route-PlateNumber="@Model.PlateNumber"
                       asp-route-CarTypeId="@Model.CarTypeId"
                       asp-route-MovementId="@Model.MovementId"
                       asp-route-CollectorId="@Model.CollectorId">
                        @i
                    </a>
                </li>
            }

        </ul>
    </nav>
}
