@page
@model VehicleTax.Web.Pages.Reports.ReceiptReferencesModel
@{
    ViewData["Title"] = "Receipt Reference Report";
}

<h3 class="fw-bold mb-4">Receipt Reference Report</h3>

<form method="get" class="card p-3 mb-3 shadow-sm">
    <div class="row g-3">

        <div class="col-md-4">
            <label class="form-label">Search (All Fields)</label>
            <input name="Search"
                   value="@Model.Search"
                   class="form-control"
                   placeholder="Reference, Plate, Collector, Cancelled by, Reason..." />
        </div>

        <div class="col-md-2">
            <label class="form-label">Vehicle</label>
            <select name="VehicleId" class="form-select">
                <option value="">All Vehicles</option>
                @foreach (var v in Model.Vehicles)
                {
                    <option value="@v.Id" selected="@(Model.VehicleId == v.Id)">
                        @v.PlateNumber
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Collector</label>
            <select name="Collector" class="form-select">
                <option value="">All Collectors</option>
                @foreach (var c in Model.Collectors)
                {
                    <option value="@c" selected="@(Model.Collector == c)">
                        @c
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Status</label>
            <select name="Status" class="form-select">
                <option value="">All</option>
                <option value="Available" selected="@(Model.Status=="Available")">Available</option>
                <option value="Used" selected="@(Model.Status=="Used")">Used</option>
                <option value="Cancelled" selected="@(Model.Status=="Cancelled")">Cancelled</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Show</label>
            <select name="PageSize" class="form-select" onchange="this.form.submit()">
                <option value="10" selected="@(Model.PageSize==10)">10</option>
                <option value="20" selected="@(Model.PageSize==20)">20</option>
                <option value="50" selected="@(Model.PageSize==50)">50</option>
                <option value="100" selected="@(Model.PageSize==100)">100</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">From Date</label>
            <input type="date"
                   name="FromDate"
                   value="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                   class="form-control" />
        </div>

        <div class="col-md-2">
            <label class="form-label">To Date</label>
            <input type="date"
                   name="ToDate"
                   value="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                   class="form-control" />
        </div>

        <div class="col-md-12 text-end">
            <button class="btn btn-primary">
                <i class="bi bi-search"></i> Filter
            </button>

            <a asp-page-handler="ExportCsv"
               asp-route-search="@Model.Search"
               asp-route-status="@Model.Status"
               asp-route-vehicleId="@Model.VehicleId"
               asp-route-collector="@Model.Collector"
               asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
               asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
               class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Export CSV
            </a>
        </div>
    </div>
</form>

<div class="table-responsive shadow-sm">
    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Reference</th>
                <th>Status</th>
                <th>Vehicle Plate</th>
                <th>Collector</th>
                <th>Used At</th>
                <th>Cancelled By</th>
                <th>Cancelled Reason</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var r in Model.ReceiptReferences)
        {
            var status = r.IsCancelled ? "Cancelled" : r.IsUsed ? "Used" : "Available";
            var badge = r.IsCancelled ? "danger" : r.IsUsed ? "success" : "secondary";

            <tr>
                <td>@r.Id</td>
                <td>@r.ReferenceNumber</td>
                <td><span class="badge bg-@badge">@status</span></td>
                <td>@r.Vehicle?.PlateNumber</td>
                <td>@r.UsedBy</td>
                <td>@r.UsedAt?.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@r.CancelledBy</td>
                <td>@r.CancelledReason</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<nav class="mt-3">
    <ul class="pagination justify-content-center">
        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                <a class="page-link"
                   href="?PageNumber=@i
                   &PageSize=@Model.PageSize
                   &Search=@Model.Search
                   &Status=@Model.Status
                   &VehicleId=@Model.VehicleId
                   &Collector=@Model.Collector
                   &FromDate=@Model.FromDate?.ToString("yyyy-MM-dd")
                   &ToDate=@Model.ToDate?.ToString("yyyy-MM-dd")">
                    @i
                </a>
            </li>
        }
    </ul>
</nav>
